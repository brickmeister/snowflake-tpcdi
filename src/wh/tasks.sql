-- Tasks that monitor data in TPCDI_STG
CREATE OR REPLACE TASK TPCDI_WH.PUBLIC.DIM_CUSTOMER_INCREMENTAL_TSK
  WAREHOUSE = TPCDI_GENERAL
  WHEN SYSTEM$STREAM_HAS_DATA('TPCDI_STG.PUBLIC.CUSTOMER_STG_STM')
AS
CALL TPCDI_WH.PUBLIC.DIM_CUSTOMER_MASTER_SP()
;
CREATE OR REPLACE TASK TPCDI_WH.PUBLIC.DIM_DATE_HISTORICAL_TSK
  WAREHOUSE = TPCDI_GENERAL
WHEN
  SYSTEM$STREAM_HAS_DATA('TPCDI_STG.PUBLIC.DATE_STG_STM')
AS
CALL TPCDI_WH.PUBLIC.DIM_DATE_HISTORICAL_SP()
;
CREATE OR REPLACE TASK TPCDI_WH.PUBLIC.DIM_INDUSTRY_HISTORICAL_TSK
  WAREHOUSE = TPCDI_GENERAL
WHEN
  SYSTEM$STREAM_HAS_DATA('TPCDI_STG.PUBLIC.INDUSTRY_STG_STM')
AS
CALL TPCDI_WH.PUBLIC.DIM_INDUSTRY_HISTORICAL_SP()
;
CREATE OR REPLACE TASK TPCDI_WH.PUBLIC.DIM_REFERENCE_HISTORICAL_TSK
  WAREHOUSE = TPCDI_GENERAL
AS
CALL TPCDI_WH.PUBLIC.DIM_REFERENCE_HISTORICAL_SP()
;
CREATE OR REPLACE TASK TPCDI_WH.PUBLIC.DIM_STATUS_TYPE_HISTORICAL_TSK
  WAREHOUSE = TPCDI_GENERAL
WHEN
  SYSTEM$STREAM_HAS_DATA('TPCDI_STG.PUBLIC.STATUSTYPE_STG_STM')
AS
CALL TPCDI_WH.PUBLIC.DIM_STATUS_TYPE_HISTORICAL_SP()
;
CREATE OR REPLACE TASK TPCDI_WH.PUBLIC.DIM_TAX_RATE_HISTORICAL_TSK
  WAREHOUSE = TPCDI_GENERAL
WHEN
  SYSTEM$STREAM_HAS_DATA('TPCDI_STG.PUBLIC.TAXRATE_STG_STM')
AS
CALL TPCDI_WH.PUBLIC.DIM_TAX_RATE_HISTORICAL_SP()
;
CREATE OR REPLACE TASK TPCDI_WH.PUBLIC.DIM_TIME_HISTORICAL_TSK
  WAREHOUSE = TPCDI_GENERAL
WHEN
  SYSTEM$STREAM_HAS_DATA('TPCDI_STG.PUBLIC.TIME_STG_STM')
AS
CALL TPCDI_WH.PUBLIC.DIM_TIME_HISTORICAL_SP()
;
CREATE OR REPLACE TASK TPCDI_WH.PUBLIC.DIM_TRADE_TYPE_HISTORICAL_TSK
  WAREHOUSE = TPCDI_GENERAL
WHEN
  SYSTEM$STREAM_HAS_DATA('TPCDI_STG.PUBLIC.TRADETYPE_STG_STM')
AS
CALL TPCDI_WH.PUBLIC.DIM_TRADE_TYPE_HISTORICAL_SP()
;
CREATE OR REPLACE TASK TPCDI_WH.PUBLIC.FACT_MARKET_HISTORY_INCREMENTAL_TSK
  WAREHOUSE = TPCDI_GENERAL
  WHEN SYSTEM$STREAM_HAS_DATA('TPCDI_STG.PUBLIC.DAILYMARKET_STG_STM')
AS
CALL TPCDI_WH.PUBLIC.FACT_MARKET_HISTORY_INCREMENTAL_MASTER_SP();



CREATE OR REPLACE TASK TPCDI_WH.PUBLIC.CHECK_STREAM_CTRL_TSK
	WAREHOUSE = TPCDI_GENERAL
WHEN SYSTEM$STREAM_HAS_DATA('TPCDI_WH.PUBLIC.DIM_ACCOUNT_STM') AND SYSTEM$STREAM_HAS_DATA('TPCDI_WH.PUBLIC.DIM_SECURITY_STM')
AS
CALL TPCDI_WH.PUBLIC.MAINTENANCE_SP();

CREATE OR REPLACE TASK TPCDI_WH.PUBLIC.DIM_TRADE_HISTORICAL_TSK
  WAREHOUSE = TPCDI_GENERAL
AS
CALL TPCDI_WH.PUBLIC.DIM_TRADE_HISTORICAL_SP();

CREATE OR REPLACE TASK TPCDI_WH.PUBLIC.FACT_HOLDINGS_HISTORICAL_TSK
  WAREHOUSE = TPCDI_GENERAL
  AFTER TPCDI_WH.PUBLIC.DIM_TRADE_HISTORICAL_TSK
AS
CALL TPCDI_WH.PUBLIC.FACT_HOLDINGS_HISTORICAL_SP();

CREATE OR REPLACE TASK TPCDI_WH.PUBLIC.INCREMENTAL_LOAD_1000_CTRL_TSK
  WAREHOUSE = TPCDI_GENERAL
  AFTER TPCDI_WH.PUBLIC.FACT_HOLDINGS_HISTORICAL_TSK
AS
CALL TPCDI_STG.PUBLIC.START_LOAD_INCREMENTAL_TASKS_SP(1000);

CREATE OR REPLACE TASK TPCDI_WH.PUBLIC.INCREMENTAL_DW_100_CTRL_TSK
  WAREHOUSE = TPCDI_GENERAL
  AFTER TPCDI_WH.PUBLIC.FACT_HOLDINGS_HISTORICAL_TSK
AS
CALL TPCDI_WH.PUBLIC.START_DW_INCREMENTAL_TASKS_SP();

CREATE OR REPLACE TASK TPCDI_WH.PUBLIC.INCREMENTAL_LOAD_100_CTRL_TSK
  WAREHOUSE = TPCDI_GENERAL
  AFTER TPCDI_WH.PUBLIC.INCREMENTAL_DW_100_CTRL_TSK
AS
CALL TPCDI_STG.PUBLIC.START_LOAD_INCREMENTAL_TASKS_SP(100);

CREATE OR REPLACE TASK TPCDI_WH.PUBLIC.INCREMENTAL_DW_10_CTRL_TSK
  WAREHOUSE = TPCDI_GENERAL
  AFTER TPCDI_WH.PUBLIC.FACT_HOLDINGS_HISTORICAL_TSK
AS
CALL TPCDI_WH.PUBLIC.START_DW_INCREMENTAL_TASKS_SP();

CREATE OR REPLACE TASK TPCDI_WH.PUBLIC.INCREMENTAL_LOAD_10_CTRL_TSK
  WAREHOUSE = TPCDI_GENERAL
  AFTER TPCDI_WH.PUBLIC.INCREMENTAL_DW_10_CTRL_TSK
AS
CALL TPCDI_STG.PUBLIC.START_LOAD_INCREMENTAL_TASKS_SP(10);

CREATE OR REPLACE TASK TPCDI_WH.PUBLIC.INCREMENTAL_DW_5_CTRL_TSK
  WAREHOUSE = TPCDI_GENERAL
  AFTER TPCDI_WH.PUBLIC.FACT_HOLDINGS_HISTORICAL_TSK
AS
CALL TPCDI_WH.PUBLIC.START_DW_INCREMENTAL_TASKS_SP();

CREATE OR REPLACE TASK TPCDI_WH.PUBLIC.INCREMENTAL_LOAD_5_CTRL_TSK
  WAREHOUSE = TPCDI_GENERAL
  AFTER TPCDI_WH.PUBLIC.INCREMENTAL_DW_5_CTRL_TSK
AS
CALL TPCDI_STG.PUBLIC.START_LOAD_INCREMENTAL_TASKS_SP(5)
;

-- Tasks that utilize only TCPDI_WH data
CREATE OR REPLACE TASK TPCDI_WH.PUBLIC.DIM_CUSTOMER_HISTORICAL_TSK
  WAREHOUSE = TPCDI_GENERAL
  AFTER TPCDI_WH.PUBLIC.DIM_REFERENCE_HISTORICAL_TSK
AS
CALL TPCDI_WH.PUBLIC.DIM_CUSTOMER_HISTORICAL_SP();

CREATE OR REPLACE TASK TPCDI_WH.PUBLIC.DIM_ACCOUNT_HISTORICAL_TSK
  WAREHOUSE = TPCDI_GENERAL
  AFTER TPCDI_WH.PUBLIC.DIM_CUSTOMER_HISTORICAL_TSK
AS
CALL TPCDI_WH.PUBLIC.DIM_ACCOUNT_HISTORICAL_SP()
;
CREATE OR REPLACE TASK TPCDI_WH.PUBLIC.DIM_ACCOUNT_INCREMENTAL_TSK
  WAREHOUSE = TPCDI_GENERAL
  AFTER TPCDI_WH.PUBLIC.DIM_CUSTOMER_INCREMENTAL_TSK
AS
CALL TPCDI_WH.PUBLIC.DIM_ACCOUNT_MASTER_SP()
;
CREATE OR REPLACE TASK TPCDI_WH.PUBLIC.DIM_BROKER_HISTORICAL_TSK
  WAREHOUSE = TPCDI_GENERAL
  AFTER TPCDI_WH.PUBLIC.DIM_REFERENCE_HISTORICAL_TSK
AS
CALL TPCDI_WH.PUBLIC.DIM_BROKER_HISTORICAL_SP()
;
CREATE OR REPLACE TASK TPCDI_WH.PUBLIC.DIM_COMPANY_HISTORICAL_TSK
  WAREHOUSE = TPCDI_GENERAL
  AFTER TPCDI_WH.PUBLIC.DIM_REFERENCE_HISTORICAL_TSK
AS
CALL TPCDI_WH.PUBLIC.DIM_COMPANY_HISTORICAL_SP()
;
CREATE OR REPLACE TASK TPCDI_WH.PUBLIC.DIM_COMPANY_TSK
  WAREHOUSE = TPCDI_GENERAL
AS
CALL TPCDI_WH.PUBLIC.DIM_COMPANY_SP();

CREATE OR REPLACE TASK TPCDI_WH.PUBLIC.DIM_FINANCIAL_HISTORICAL_TSK
  WAREHOUSE = TPCDI_GENERAL
  AFTER TPCDI_WH.PUBLIC.DIM_COMPANY_HISTORICAL_TSK
AS
CALL TPCDI_WH.PUBLIC.DIM_FINANCIAL_HISTORICAL_SP();

CREATE OR REPLACE TASK TPCDI_WH.PUBLIC.DIM_FINANCIAL_TSK
  WAREHOUSE = TPCDI_GENERAL
AS
CALL TPCDI_WH.PUBLIC.DIM_FINANCIAL_SP()
;


CREATE OR REPLACE TASK TPCDI_WH.PUBLIC.DIM_SECURITY_HISTORICAL_TSK
  WAREHOUSE = TPCDI_GENERAL
  AFTER TPCDI_WH.PUBLIC.DIM_COMPANY_HISTORICAL_TSK
AS 
CALL TPCDI_WH.PUBLIC.DIM_SECURITY_HISTORICAL_SP()
;
CREATE OR REPLACE TASK TPCDI_WH.PUBLIC.DIM_SECURITY_TSK
  WAREHOUSE = TPCDI_GENERAL
AS
CALL TPCDI_WH.PUBLIC.DIM_SECURITY_SP();

CREATE OR REPLACE TASK TPCDI_WH.PUBLIC.DIM_TRADE_INCREMENTAL_TSK
  WAREHOUSE = TPCDI_GENERAL
  AFTER TPCDI_WH.PUBLIC.DIM_ACCOUNT_INCREMENTAL_TSK
AS
CALL TPCDI_WH.PUBLIC.DIM_TRADE_INCREMENTAL_SP()
;CREATE OR REPLACE TASK TPCDI_WH.PUBLIC.FACT_CASH_BALANCES_HISTORICAL_TSK
  WAREHOUSE = TPCDI_GENERAL
  AFTER TPCDI_WH.PUBLIC.DIM_ACCOUNT_HISTORICAL_TSK
AS
CALL TPCDI_WH.PUBLIC.FACT_CASH_BALANCES_HISTORICAL_SP()
;
CREATE OR REPLACE TASK TPCDI_WH.PUBLIC.FACT_CASH_BALANCES_INCREMENTAL_TSK
  WAREHOUSE = TPCDI_GENERAL
  AFTER TPCDI_WH.PUBLIC.DIM_ACCOUNT_INCREMENTAL_TSK
AS
CALL TPCDI_WH.PUBLIC.FACT_CASH_BALANCES_INCREMENTAL_SP();

CREATE OR REPLACE TASK TPCDI_WH.PUBLIC.FACT_HOLDINGS_INCREMENTAL_TSK
  WAREHOUSE = TPCDI_GENERAL
  AFTER TPCDI_WH.PUBLIC.DIM_TRADE_INCREMENTAL_TSK
AS
CALL TPCDI_WH.PUBLIC.FACT_HOLDINGS_INCREMENTAL_SP()
;CREATE OR REPLACE TASK TPCDI_WH.PUBLIC.FACT_MARKET_HISTORY_HISTORICAL_TSK
  WAREHOUSE = TPCDI_GENERAL
  AFTER TPCDI_WH.PUBLIC.DIM_SECURITY_HISTORICAL_TSK
AS
CALL TPCDI_WH.PUBLIC.FACT_MARKET_HISTORY_HISTORICAL_MASTER_SP()
;
CREATE OR REPLACE TASK TPCDI_WH.PUBLIC.FACT_PROSPECT_HISTORICAL_TSK
  WAREHOUSE = TPCDI_GENERAL
  AFTER TPCDI_WH.PUBLIC.DIM_ACCOUNT_HISTORICAL_TSK
AS
CALL TPCDI_WH.PUBLIC.FACT_PROSPECT_HISTORICAL_MASTER_SP()
;
CREATE OR REPLACE TASK TPCDI_WH.PUBLIC.FACT_PROSPECT_INCREMENTAL_TSK
  WAREHOUSE = TPCDI_GENERAL
  AFTER TPCDI_WH.PUBLIC.DIM_ACCOUNT_INCREMENTAL_TSK
AS
CALL TPCDI_WH.PUBLIC.FACT_PROSPECT_INCREMENTAL_MASTER_SP();

CREATE OR REPLACE TASK TPCDI_WH.PUBLIC.FACT_WATCHES_HISTORICAL_TSK
  WAREHOUSE = TPCDI_GENERAL
AS
CALL TPCDI_WH.PUBLIC.FACT_WATCHES_HISTORICAL_SP();

CREATE OR REPLACE TASK TPCDI_WH.PUBLIC.FACT_WATCHES_INCREMENTAL_TSK
  WAREHOUSE = TPCDI_GENERAL
  AFTER TPCDI_WH.PUBLIC.DIM_ACCOUNT_INCREMENTAL_TSK
AS
CALL TPCDI_WH.PUBLIC.FACT_WATCHES_INCREMENTAL_SP();

CREATE OR REPLACE TASK TPCDI_WH.PUBLIC.INCREMENTAL_DW_1000_CTRL_TSK
  WAREHOUSE = TPCDI_GENERAL
  AFTER TPCDI_WH.PUBLIC.FACT_HOLDINGS_HISTORICAL_TSK
AS
CALL TPCDI_WH.PUBLIC.START_DW_INCREMENTAL_TASKS_SP();

CREATE OR REPLACE TASK TPCDI_WH.PUBLIC.LOAD_SNAPSHOT_TSK
	WAREHOUSE = TPCDI_GENERAL
	
AS
CALL TPCDI_WH.PUBLIC.LOAD_SNAPSHOT_SP();