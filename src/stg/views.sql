-- Create some staging views
CREATE OR REPLACE VIEW TPCDI_STG.PUBLIC.ACCOUNT_CLOSE_STG AS
  SELECT
  XML:"@ActionTS"::TIMESTAMP AS ACTION_DATE
  ,XML:"@ActionType"::STRING AS ACTION_TYPE
  ,XML:"$"."@C_ID"::NUMBER AS CUSTOMER_ID
  ,XML:"$"."$"."@CA_ID"::NUMBER AS CUSTOMER_ACCOUNT_ID
  FROM TPCDI_STG.PUBLIC.CUSTOMER_MGMT_STG
  WHERE XML:"@ActionType"::STRING = 'CLOSEACCT';

CREATE OR REPLACE VIEW TPCDI_STG.PUBLIC.ACCOUNT_NEW_STG AS
  SELECT
  XML:"@ActionTS"::TIMESTAMP AS ACTION_DATE
  ,XML:"@ActionType"::STRING AS ACTION_TYPE
  ,XML:"$"."@C_ID"::NUMBER AS CUSTOMER_ID
  ,XML:"$"."$"."@CA_ID"::NUMBER AS CUSTOMER_ACCOUNT_ID
  ,XML:"$"."$"."@CA_TAX_ST"::NUMBER AS CUSTOMER_ACCOUNT_TAX_STATUS
  ,XML:"$"."$"."$"[0]."$"::STRING AS CUSTOMER_ACCOUNT_BROKER_ID
  ,XML:"$"."$"."$"[1]."$"::STRING AS CUSTOMER_ACCOUNT_NAME
  FROM TPCDI_STG.PUBLIC.CUSTOMER_MGMT_STG
  WHERE XML:"@ActionType"::STRING = 'ADDACCT';

CREATE OR REPLACE VIEW TPCDI_STG.PUBLIC.ACCOUNT_UPDT_STG AS
  SELECT
  XML:"@ActionTS"::TIMESTAMP AS ACTION_DATE
  ,XML:"@ActionType"::STRING AS ACTION_TYPE
  ,XML:"$"."@C_ID"::NUMBER AS CUSTOMER_ID
  ,XML:"$"."$"."@CA_ID"::NUMBER AS CUSTOMER_ACCOUNT_ID
  ,XML:"$"."$"."@CA_TAX_ST"::NUMBER AS CUSTOMER_ACCOUNT_TAX_STATUS
  ,XML:"$"."$"."$"[0]."$"::STRING AS CUSTOMER_ACCOUNT_BROKER_ID
  ,XML:"$"."$"."$"[1]."$"::STRING AS CUSTOMER_ACCOUNT_NAME
  FROM TPCDI_STG.PUBLIC.CUSTOMER_MGMT_STG
  WHERE XML:"@ActionType"::STRING = 'UPDACCT';

CREATE OR REPLACE VIEW TPCDI_STG.PUBLIC.CUSTOMER_INACT_STG AS
  SELECT XML:"$"."@C_ID"::NUMBER AS C_ID 
  FROM TPCDI_STG.PUBLIC.CUSTOMER_MGMT_STG
  WHERE XML:"@ActionType"::STRING = 'INACT';

CREATE OR REPLACE VIEW TPCDI_STG.PUBLIC.CUSTOMER_NEW_STG AS
  SELECT
    XML:"@ActionTS"::TIMESTAMP AS ACTION_DATE
  , XML:"@ActionType"::STRING AS ACTION_TYPE
  , XML:"$"."@C_DOB"::DATE AS DATE_OF_BIRTH
  , XML:"$"."@C_GNDR"::STRING AS GENDER
  , XML:"$"."@C_ID"::NUMBER AS CUSTOMER_ID
  , XML:"$"."@C_TAX_ID"::STRING AS CUSTOMER_TAX_ID
  , XML:"$"."@C_TIER"::STRING AS CUSTOMER_TIER
  , XML:"$"."$"[0]."$"[0]."$"::STRING AS LAST_NAME
  , XML:"$"."$"[0]."$"[1]."$"::STRING AS FIRST_NAME
  , XML:"$"."$"[0]."$"[2]."$"::STRING AS MIDDLE_INITIAL
  , XML:"$"."$"[1]."$"[0]."$"::STRING AS ADDRESS_LINE_1
  , XML:"$"."$"[1]."$"[1]."$"::STRING AS ADDRESS_LINE_2
  , XML:"$"."$"[1]."$"[2]."$"::STRING AS ZIP_CODE
  , XML:"$"."$"[1]."$"[3]."$"::STRING AS CITY
  , XML:"$"."$"[1]."$"[4]."$"::STRING AS STATE_PROVINCE
  , XML:"$"."$"[1]."$"[5]."$"::STRING AS COUNTRY
  , XML:"$"."$"[2]."$"[0]."$"::STRING AS PRIMARY_EMAIL
  , XML:"$"."$"[2]."$"[1]."$"::STRING AS ALTERNATE_EMAIL
  , XML:"$"."$"[2]."$"[2]."$"[0]."$"::STRING AS PHONE_1_COUNTRY_CODE
  , XML:"$"."$"[2]."$"[2]."$"[1]."$"::STRING AS PHONE_1_AREA_CODE
  , XML:"$"."$"[2]."$"[2]."$"[2]."$"::STRING AS PHONE_1_PHONE_NUMBER
  , XML:"$"."$"[2]."$"[2]."$"[3]."$"::STRING AS PHONE_1_EXTENSION
  , XML:"$"."$"[2]."$"[3]."$"[0]."$"::STRING AS PHONE_2_COUNTRY_CODE
  , XML:"$"."$"[2]."$"[3]."$"[1]."$"::STRING AS PHONE_2_AREA_CODE
  , XML:"$"."$"[2]."$"[3]."$"[2]."$"::STRING AS PHONE_2_PHONE_NUMBER
  , XML:"$"."$"[2]."$"[3]."$"[3]."$"::STRING AS PHONE_2_EXTENSION
  , XML:"$"."$"[2]."$"[4]."$"[0]."$"::STRING AS PHONE_3_COUNTRY_CODE
  , XML:"$"."$"[2]."$"[4]."$"[1]."$"::STRING AS PHONE_3_AREA_CODE
  , XML:"$"."$"[2]."$"[4]."$"[2]."$"::STRING AS PHONE_3_PHONE_NUMBER
  , XML:"$"."$"[2]."$"[4]."$"[3]."$"::STRING AS PHONE_3_EXTENSION
  , XML:"$"."$"[3]."$"[0]."$"::STRING AS LOCAL_TAX_ID
  , XML:"$"."$"[3]."$"[1]."$"::STRING AS NATIONAL_TAX_ID
  , XML:"$"."$"[4]."@CA_ID"::STRING AS CUSTOMER_ACCOUNT_ID
  , XML:"$"."$"[4]."$"[1]."$"::STRING AS CUSTOMER_ACCOUNT_NAME
  FROM TPCDI_STG.PUBLIC.CUSTOMER_MGMT_STG
  WHERE XML:"@ActionType"::STRING = 'NEW';

CREATE OR REPLACE VIEW TPCDI_STG.PUBLIC.UPDCUST_LEVEL1 AS
SELECT FL.THIS
FROM TPCDI_STG.PUBLIC.CUSTOMER_MGMT_STG
   , LATERAL FLATTEN(INPUT => TPCDI_STG.PUBLIC.CUSTOMER_MGMT_STG.XML:"$"
                            , RECURSIVE => TRUE
                            ) FL 
WHERE XML:"@ActionType"::STRING = 'UPDCUST' AND FL.PATH = '[\'$\']';

CREATE OR REPLACE VIEW TPCDI_STG.PUBLIC.UPDCUST_LEVEL2 AS 
SELECT
   THIS:"@C_ID"::NUMBER AS C_ID
 , (CASE WHEN THIS:"@C_TIER" = '' THEN NULL ELSE THIS:"@C_TIER" END)::NUMBER AS C_TIER
 , XMLGET(THIS, 'Address') AS ADDRESS
 , XMLGET(THIS, 'ContactInfo') AS CONTACTINFO
FROM TPCDI_STG.PUBLIC.UPDCUST_LEVEL1;

CREATE OR REPLACE VIEW TPCDI_STG.PUBLIC.UPDCUST_LEVEL3 AS 
SELECT
   C_ID AS C_ID
 , C_TIER AS C_TIER
 , XMLGET(ADDRESS,'C_ADLINE1'):"$"::STRING AS ADDRESSLINE1
 , XMLGET(ADDRESS,'C_ADLINE2'):"$"::STRING AS ADDRESSLINE2
 , XMLGET(ADDRESS,'C_ZIPCODE'):"$"::STRING AS ZIPCODE
 , XMLGET(ADDRESS,'C_CITY'):"$"::STRING AS CITY
 , XMLGET(ADDRESS,'C_STATE_PROV'):"$"::STRING AS STATEPROV
 , XMLGET(ADDRESS,'C_CTRY'):"$"::STRING AS COUNTRY
 , XMLGET(CONTACTINFO,'C_PRIM_EMAIL'):"$"::STRING AS PRIMARYEMAIL
 , XMLGET(CONTACTINFO,'C_ALT_EMAIL'):"$"::STRING AS ALTERNATEEMAIL
 , XMLGET(CONTACTINFO,'C_PHONE_1') AS C_PHONE_1
 , XMLGET(CONTACTINFO,'C_PHONE_2') AS C_PHONE_2
 , XMLGET(CONTACTINFO,'C_PHONE_3') AS C_PHONE_3
FROM TPCDI_STG.PUBLIC.UPDCUST_LEVEL2;

CREATE OR REPLACE VIEW TPCDI_STG.PUBLIC.CUSTOMER_UPDT_STG AS
  SELECT
    C_ID
  , C_TIER
  , ADDRESSLINE1
  , ADDRESSLINE2
  , ZIPCODE
  , CITY
  , STATEPROV
  , COUNTRY
  , PRIMARYEMAIL
  , ALTERNATEEMAIL
  , XMLGET(C_PHONE_1,'C_CTRY_CODE'):"$"::STRING AS PH1COUNTRYCODE
  , XMLGET(C_PHONE_1,'C_AREA_CODE'):"$"::STRING AS PH1AREACODE
  , XMLGET(C_PHONE_1,'C_LOCAL'):"$"::STRING AS PH1LOCALNUMBER
  , XMLGET(C_PHONE_1,'C_EXT'):"$"::STRING AS PH1EXTENSION
  , XMLGET(C_PHONE_2,'C_CTRY_CODE'):"$"::STRING AS PH2COUNTRYCODE
  , XMLGET(C_PHONE_2,'C_AREA_CODE'):"$"::STRING AS PH2AREACODE
  , XMLGET(C_PHONE_2,'C_LOCAL'):"$"::STRING AS PH2LOCALNUMBER
  , XMLGET(C_PHONE_2,'C_EXT'):"$"::STRING AS PH2EXTENSION
  , XMLGET(C_PHONE_3,'C_CTRY_CODE'):"$"::STRING AS PH3COUNTRYCODE
  , XMLGET(C_PHONE_3,'C_AREA_CODE'):"$"::STRING AS PH3AREACODE
  , XMLGET(C_PHONE_3,'C_LOCAL'):"$"::STRING AS PH3LOCALNUMBER
  , XMLGET(C_PHONE_3,'C_EXT'):"$"::STRING AS PH3EXTENSION
  FROM TPCDI_STG.PUBLIC.UPDCUST_LEVEL3;

CREATE OR REPLACE VIEW TPCDI_STG.PUBLIC.FINWIRE_CMP_STG AS
  SELECT
      TO_TIMESTAMP_NTZ(PTS,'YYYYMMDD-HH24MISS') AS PTS,
      REC_TYPE,
      COMPANY_NAME,
      CIK,
      STATUS,
      INDUSTRY_ID,
      SP_RATING,
      TRY_TO_DATE(FOUNDING_DATE) AS FOUNDING_DATE,
      ADDR_LINE1,
      ADDR_LINE2,
      POSTAL_CODE,
      CITY,
      STATE_PROVINCE,
      COUNTRY,
      CEO_NAME,
      DESCRIPTION
  FROM TPCDI_STG.PUBLIC.FINWIRE_STG
  WHERE REC_TYPE = 'CMP';

CREATE OR REPLACE VIEW TPCDI_STG.PUBLIC.FINWIRE_FIN_STG AS
  SELECT
      TO_TIMESTAMP_NTZ(PTS,'YYYYMMDD-HH24MISS') AS PTS,
      REC_TYPE,
      TO_NUMBER(YEAR,4,0) AS YEAR,
      TO_NUMBER(QUARTER,1,0) AS QUARTER,
      TO_DATE(QTR_START_DATE, 'YYYYMMDD') AS QTR_START_DATE,
      TO_DATE(POSTING_DATE, 'YYYYMMDD') AS POSTING_DATE,
      TO_NUMBER(REVENUE,15,2) AS REVENUE,
      TO_NUMBER(EARNINGS,15,2) AS EARNINGS,
      TO_NUMBER(EPS,10,2) AS EPS,
      TO_NUMBER(DILUTED_EPS,10,2) AS DILUTED_EPS,
      TO_NUMBER(MARGIN,10,2) AS MARGIN,
      TO_NUMBER(INVENTORY,15,2) AS INVENTORY,
      TO_NUMBER(ASSETS,15,2) AS ASSETS,
      TO_NUMBER(LIABILITIES,15,2) AS LIABILITIES,
      TO_NUMBER(SH_OUT,13,0) AS SH_OUT,
      TO_NUMBER(DILUTED_SH_OUT,13,0) AS DILUTED_SH_OUT,
      CO_NAME_OR_CIK 
  FROM TPCDI_STG.PUBLIC.FINWIRE_STG
  WHERE REC_TYPE = 'FIN'; 

CREATE OR REPLACE VIEW TPCDI_STG.PUBLIC.FINWIRE_SEC_STG AS
  SELECT
      TO_TIMESTAMP_NTZ(PTS,'YYYYMMDD-HH24MISS') AS PTS,
      REC_TYPE,
      SYMBOL,
      ISSUE_TYPE,
      STATUS,
      NAME,
      EX_ID,
      TO_NUMBER(SH_OUT,13,0) AS SH_OUT,
      TO_DATE(FIRST_TRADE_DATE,'YYYYMMDD') AS FIRST_TRADE_DATE,
      TO_DATE(FIRST_TRADE_EXCHG,'YYYYMMDD') AS FIRST_TRADE_EXCHG,
      TO_NUMBER(DIVIDEND,10,2) AS DIVIDEND,
      CO_NAME_OR_CIK
  FROM TPCDI_STG.PUBLIC.FINWIRE_STG
  WHERE REC_TYPE = 'SEC';

